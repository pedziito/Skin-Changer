name: Build CS2 Loader

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    
    strategy:
      matrix:
        build_type: [Release]
        
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Install dependencies
      run: |
        choco install cmake -y
        
    - name: Setup MSVC
      uses: ilammy/msvc-dev-cmd@v1
      
    - name: Create build directory
      run: mkdir build

    - name: Configure CMake
      run: |
        cd build
        cmake .. -G "Visual Studio 17 2022" -A x64 -DCMAKE_BUILD_TYPE=${{ matrix.build_type }}
      
    - name: Build project
      run: |
        cd build
        cmake --build . --config ${{ matrix.build_type }} --verbose
        
    - name: Create Release Artifacts
      shell: pwsh
      run: |
        New-Item -ItemType Directory -Force -Path release_package | Out-Null
        
        if (Test-Path -Path "build\bin\cs2loader.exe") {
          Copy-Item -Path "build\bin\cs2loader.exe" -Destination "release_package\cs2loader.exe" -Force
          Write-Host "✓ cs2loader.exe copied"
        } else {
          Write-Host "✗ cs2loader.exe not found"
        }
        
        if (Test-Path -Path "build\bin\CS2Changer.dll") {
          Copy-Item -Path "build\bin\CS2Changer.dll" -Destination "release_package\CS2Changer.dll" -Force
          Write-Host "✓ CS2Changer.dll copied"
        } else {
          Write-Host "✗ CS2Changer.dll not found"
        }
        
        if (Test-Path -Path "build\bin\cs2admin.exe") {
          Copy-Item -Path "build\bin\cs2admin.exe" -Destination "release_package\cs2admin.exe" -Force
          Write-Host "✓ cs2admin.exe copied"
        } else {
          Write-Host "✗ cs2admin.exe not found (optional)"
        }
        
        $readmeLines = @(
          "CS2 SKIN CHANGER - Release Package",
          "",
          "Files:",
          "- cs2loader.exe: Main loader application",
          "- CS2Changer.dll: Game hook DLL",
          "- cs2admin.exe: License management tool (optional)",
          "",
          "Installation:",
          "1. Place cs2loader.exe and CS2Changer.dll in same folder",
          "2. Obtain license.key from admin",
          "3. Run cs2loader.exe",
          "4. Accept VAC warning",
          "5. Start CS2 game",
          "6. Press INS to open menu"
        )
        Set-Content -Path "release_package\README.txt" -Value $readmeLines -Force
        Write-Host "✓ README.txt created"
        
    - name: Upload cs2loader.exe
      uses: actions/upload-artifact@v4
      with:
        name: cs2loader
        path: release_package/cs2loader.exe
        retention-days: 30
        
    - name: Upload CS2Changer.dll
      uses: actions/upload-artifact@v4
      with:
        name: CS2Changer-dll
        path: release_package/CS2Changer.dll
        retention-days: 30
        
    - name: Upload cs2admin.exe
      uses: actions/upload-artifact@v4
      with:
        name: cs2admin-tool
        path: release_package/cs2admin.exe
        retention-days: 30
        
    - name: Upload all artifacts as ZIP
      uses: actions/upload-artifact@v4
      with:
        name: CS2Changer-Complete
        path: release_package/
        retention-days: 30

    - name: Create Release
      if: startsWith(github.ref, 'refs/tags/')
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ github.ref }}
        release_name: CS2 Loader ${{ github.ref }}
        body: |
          CS2 Skin Changer Release
          
          Files included:
          - cs2loader.exe: Main loader application
          - CS2Changer.dll: Game hook DLL
          - cs2admin.exe: License management tool
          
          Installation:
          1. Place cs2loader.exe and CS2Changer.dll in same folder
          2. Obtain license.key from admin
          3. Run cs2loader.exe
          4. Accept VAC warning
          5. Start CS2 game
          6. Press INS to open menu
